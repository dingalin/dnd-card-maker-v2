<section class="preview-panel">

    <!-- Flexbox Layout: [Ability Scroll] [Card] [Sticky Note] -->
    <div class="preview-layout">

        <!-- Ability Scroll Area - Container for scroll + buttons BELOW it -->
        <div class="ability-scroll-container">
            <!-- The scroll image with clickable icon overlay -->
            <div class="ability-scroll-panel" id="ability-scroll-panel">
                <img id="scroll-image" class="scroll-image" src="assets/icons/a.png" alt="Ability Scroll">
                <div class="ability-icons-overlay" id="ability-icons-overlay">
                    <!-- Clickable icon areas will be generated by AbilitySelectorController -->
                </div>
            </div>

            <!-- Controls area BELOW the scroll - switches between states (golden border) -->
            <div class="ability-controls-area" id="ability-controls-area">
                <!-- State 1: Initial button for manual ability selection -->
                <div class="ability-state ability-state-initial" id="ability-state-initial">
                    <div class="manual-ability-btn" id="manual-ability-btn">
                        <span class="manual-btn-icon">⚔️</span>
                        <span class="manual-btn-text">בחירת יכולות ידנית</span>
                    </div>
                </div>

                <!-- State 2: Rarity Selection -->
                <div class="ability-state ability-state-rarity hidden" id="ability-state-rarity">
                    <div class="rarity-title">בחר רמת חפץ</div>
                    <div class="rarity-buttons" id="rarity-buttons">
                        <!-- Will be populated by AbilitySelectorController -->
                    </div>
                </div>

                <!-- State 3: Category Buttons -->
                <div class="ability-state ability-state-categories hidden" id="ability-state-categories">
                    <div class="ability-category-buttons" id="ability-category-buttons">
                        <!-- Will be populated by AbilitySelectorController -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main card display - Center -->
        <div class="canvas-container">
            <canvas id="card-canvas" width="600" height="840"></canvas>
            <canvas id="card-canvas-back" width="600" height="840" class="hidden"></canvas>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden">
                <div class="loading-content">
                    <div class="progress-steps">
                        <div class="step" data-step="1">
                            <div class="step-icon">💭</div>
                            <div class="step-label" data-i18n="preview.step1">רעיון</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="2">
                            <div class="step-icon">✍️</div>
                            <div class="step-label" data-i18n="preview.step2">תיאור</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="3">
                            <div class="step-icon">🎨</div>
                            <div class="step-label" data-i18n="preview.step3">ציור</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="4">
                            <div class="step-icon">✨</div>
                            <div class="step-label" data-i18n="preview.step4">סיום</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <p id="loading-text" data-i18n="preview.loading">מתחיל...</p>
                    <button id="cancel-btn" class="cancel-btn" data-i18n="preview.cancel">ביטול</button>
                </div>
            </div>

            <!-- Preview Controls (Inside canvas-container to stay with card) -->
            <div class="preview-controls">
                <button id="equip-item-btn" class="btn-primary" data-i18n-title="preview.equipCharacter"
                    title="צייד דמות" style="background: linear-gradient(135deg, #e67e22, #d35400);">
                    <span data-i18n="preview.equipCharacter">🗡️ צייד דמות</span>
                </button>
                <button id="split-view-btn" class="btn-secondary" data-i18n-title="preview.splitView"
                    title="תצוגה מפוצלת">
                    <span data-i18n="preview.splitView">📄|📄 פיצול</span>
                </button>
                <button id="flip-card-btn" class="card-viewer-btn card-viewer-btn-primary"
                    data-i18n-title="preview.flipBack" title="הפוך קלף">
                    <span data-i18n="preview.flipBack">↻ הצג אחורה</span>
                </button>
            </div>
        </div>

        <!-- Sticky Note - Right side of card -->
        <div class="sticky-note-container">
            <div class="sticky-note" id="sticky-note">
                <h3 data-i18n="stickyNote.title">🗡️ פרטי חפץ</h3>

                <!-- Normal Mode Content -->
                <div class="note-content" id="note-content-normal">
                    <div class="note-row">
                        <span class="note-label" data-i18n="stickyNote.name">שם:</span>
                        <span class="note-value" id="note-name">-</span>
                    </div>
                    <div class="note-divider"></div>
                    <div class="note-row">
                        <span class="note-label" data-i18n="stickyNote.type">סוג:</span>
                        <span class="note-value" id="note-type">-</span>
                    </div>
                    <div class="note-row">
                        <span class="note-label" data-i18n="stickyNote.rarity">נדירות:</span>
                        <span class="note-value" id="note-rarity">-</span>
                    </div>
                    <div class="note-divider"></div>
                    <div class="note-row">
                        <span class="note-label" data-i18n="stickyNote.price">מחיר:</span>
                        <span class="note-value" id="note-price">-</span>
                    </div>

                    <!-- Additional Details -->
                    <div class="note-divider"></div>

                    <div class="note-row" id="note-ability-row">
                        <span class="note-label" data-i18n="stickyNote.ability">נושא:</span>
                        <span class="note-value-small" id="note-ability">-</span>
                    </div>

                    <div class="note-row" id="note-style-row">
                        <span class="note-label" data-i18n="stickyNote.style">סגנון:</span>
                        <span class="note-value-small" id="note-style">-</span>
                    </div>

                    <!-- Badges -->
                    <div class="note-modifiers" id="note-modifiers">
                        <span id="note-visual-context" class="note-badge hidden"
                            data-i18n="stickyNote.visualContextBadge">🎨 רקע קלף</span>
                        <span id="note-attunement" class="note-badge hidden" data-i18n="stickyNote.attunementBadge">🔗
                            התכווננות</span>
                        <span id="note-damage" class="note-badge hidden"></span>
                        <span id="note-ac" class="note-badge hidden"></span>
                    </div>
                </div>

                <!-- Ability Selection Mode Content (hidden by default) -->
                <div class="note-content note-content-abilities hidden" id="note-content-abilities">
                    <!-- Budget Display -->
                    <div class="ability-budget-display">
                        <div class="budget-header">
                            <span class="budget-icon" id="note-rarity-icon">🔵</span>
                            <span class="budget-rarity-name" id="note-rarity-name">נדיר</span>
                        </div>
                        <div class="budget-bar-container">
                            <div class="budget-bar" id="note-budget-bar">
                                <div class="budget-bar-fill" id="note-budget-fill"></div>
                            </div>
                            <span class="budget-text">
                                <span id="note-budget-used">0</span>/<span id="note-budget-max">8</span>
                            </span>
                        </div>
                    </div>

                    <div class="note-divider"></div>

                    <!-- Selected Abilities List -->
                    <div class="selected-abilities-section">
                        <div class="abilities-header">✨ יכולות נבחרות</div>
                        <div class="abilities-list" id="note-abilities-list">
                            <div class="no-abilities">לא נבחרו יכולות</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</section>

<!-- Fullscreen Modal -->
<div id="fullscreen-modal" class="fullscreen-modal hidden">
    <button id="close-fullscreen-btn" class="close-fullscreen-btn">✕</button>
    <div class="fullscreen-canvas-container">
        <canvas id="fullscreen-canvas"></canvas>
    </div>
    <div class="zoom-controls">
        <button id="zoom-out-btn" class="zoom-btn">−</button>
        <span id="zoom-level">100%</span>
        <button id="zoom-in-btn" class="zoom-btn">+</button>
        <button id="zoom-reset-btn" class="zoom-btn">↻</button>
    </div>
</div>